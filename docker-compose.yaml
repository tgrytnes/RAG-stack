services:
  weaviate:
    image: semitechnologies/weaviate:latest
    container_name: weaviate
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      - PERSISTENCE_DATA_PATH=/var/lib/weaviate
      - QUERY_DEFAULTS_LIMIT=25
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=true
      - DEFAULT_VECTORIZER_MODULE=none
      - CLUSTER_HOSTNAME=node1
    volumes:
      - /mnt/sda1/digital_vault/.weaviate_data:/var/lib/weaviate

  etl:
    build:
      context: ./etl
    container_name: vault-etl
    restart: unless-stopped
    depends_on:
      - weaviate
    environment:
      - INBOX_DIR=/app/inbox
      - ARCHIVE_DIR=/app/archive
      - STAGING_DIR=/app/staging
      - WEAVIATE_URL=http://weaviate:8080
    volumes:
      - /mnt/sda1/digital_vault/01_inbox:/app/inbox
      - /mnt/sda1/digital_vault/03_archive:/app/archive
      - /mnt/sda1/digital_vault/.staging:/app/staging

  embedder:
    build:
      context: ./embedder
    container_name: vault-embedder
    restart: unless-stopped
    depends_on:
      - weaviate
    environment:
      - STAGING_DIR=/app/staging
      - ACTIVE_DIR=/app/active_docs
      - ARCHIVE_DIR=/app/archive
      - WEAVIATE_URL=http://weaviate:8080
      - OLLAMA_URL=http://host.docker.internal:11434
      - EMBED_MODEL=nomic-embed-text
      - CHAT_MODEL=llama3.2
      # Optional: API_BASE for absolute links in responses (e.g., http://<pi-ip>:8001)
      # - API_BASE=http://<pi-ip>:8001
      - EMBED_PORT=8000
    volumes:
      - /mnt/sda1/digital_vault/.staging:/app/staging
      - /mnt/sda1/digital_vault/02_active:/app/active_docs:ro
      - /mnt/sda1/digital_vault/03_archive:/app/archive:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "8001:8000"
